# 在庫管理アプリケーション セットアップ＆取扱説明書

## **Part 1: ラズパイ設置・運用手順書**
（システムをセットアップする方向け）

### 1. 概要
このドキュメントは、委託在庫管理アプリケーションをRaspberry Pi（ラズパイ）上で構築し、運用するための手順を説明するものです。

### 2. 必要なもの
#### ハードウェア
*   Raspberry Pi 4（推奨）または Raspberry Pi 3
*   MicroSDカード（32GB以上推奨）
*   Raspberry Pi用電源アダプター
*   （セットアップ時）USBキーボード、マウス、HDMI対応モニター
*   有線LANケーブルまたはWiFi接続環境

#### ソフトウェア
*   **Raspberry Pi Imager:** OSをSDカードに書き込むためのツール
*   **ターミナルソフト (例: PowerShell, Tera Term 등):** ラズパイにSSH接続するためのクライアント

### 3. ラズパイの初期セットアップ
1.  **OSのインストール:**
    *   PCで「Raspberry Pi Imager」を起動します。
    *   「OSを選ぶ」から「Raspberry Pi OS (64-bit)」を選択します。
    *   書き込み設定（歯車アイコン）で、以下を必ず設定します。
        *   **ホスト名:** `raspberrypi.local` のままでOK
        *   **SSHを有効化する:** 「パスワード認証を使う」をオン
        *   **ユーザー名とパスワードを設定する:** ユーザー名を`pi`、任意のパスワードを設定
        *   **Wi-Fiを設定する:** 必要に応じて設定
    *   設定を保存し、SDカードにOSを書き込みます。

2.  **ラズパイの起動と接続:**
    *   OSを書き込んだSDカードをラズパイに挿入し、電源を入れます。
    *   PCのターミナルソフトから、以下のコマンドでラズパイにSSH接続します。
        ```shell
        ssh pi@raspberrypi.local
        ```
    *   設定したパスワードを入力してログインします。

### 4. アプリケーションのインストールと起動
ラズパイにログインした状態で、以下のコマンドを順番に実行します。

1.  **GitとDockerをインストールします。**
    ```shell
    # パッケージリストを更新
    sudo apt-get update
    
    # Gitをインストール
    sudo apt-get install -y git
    
    # Dockerをインストール
    curl -sSL https://get.docker.com | sh
    
    # piユーザーをdockerグループに追加（sudoなしでdockerコマンドを実行するため）
    sudo usermod -aG docker pi
    
    # 設定を反映させるため、一度ラズパイからログアウトし、再度ログインします
    exit
    ssh pi@raspberrypi.local
    ```

2.  **アプリケーションのソースコードを取得します。**
    ```shell
    # GitHubからソースコードをクローン（ダウンロード）
    git clone https://github.com/syuttyoseibi/stock-management-app.git
    
    # ダウンロードしたディレクトリに移動
    cd stock-management-app
    ```

3.  **データベース保存用のディレクトリを作成します。**
    ```shell
    # ホームディレクトリにデータベース用のフォルダを作成
    mkdir /home/pi/stock-app-data
    ```

4.  **アプリケーションを起動します。**
    *   以下のコマンドで、アプリケーションのDockerイメージをビルドし、コンテナを起動します。
    *   このコマンドにより、PCの再起動時もアプリケーションが自動で起動するようになります。
    ```shell
    # Dockerイメージをビルド
    docker build -t stock-app .
    
    # Dockerコンテナを起動
    docker run -d -p 3000:3000 -v /home/pi/stock-app-data:/app/data --name stock-manager --restart always stock-app
    ```

5.  **動作確認:**
    *   同じネットワーク内のPCやスマートフォンのブラウザで、以下のアドレスにアクセスします。
        `http://<ラズパイのIPアドレス>:3000`
    *   ログイン画面が表示されれば成功です。

### 5. アプリケーションの更新方法
今後、機能追加があった場合に、最新版にアップデートする手順です。

1.  **ラズパイにSSH接続し、アプリケーションのディレクトリに移動します。**
    ```shell
    ssh pi@raspberrypi.local
    cd stock-management-app
    ```

2.  **最新のソースコードを取得します。**
    ```shell
    git pull
    ```

3.  **コンテナを再作成します。**
    ```shell
    # 古いコンテナを停止
    docker stop stock-manager
    
    # 古いコンテナを削除
    docker rm stock-manager
    
    # キャッシュを使わずに新しいイメージを再ビルド
    docker build --no-cache -t stock-app .
    
    # 新しいコンテナを起動（APIキーを使う場合は --env-file オプションを忘れずに）
    docker run -d -p 3000:3000 -v /home/pi/stock-app-data:/app/data --name stock-manager --restart always stock-app
    ```

### 6. データのバックアップと復元
アプリケーションの全データは、ラズパイ本体の`/home/pi/stock-app-data/stock.db`という単一のファイルに保存されています。

#### バックアップ
このファイルを定期的にコピーして保管してください。
```shell
# 例: USBメモリなどにバックアップする場合（パスは環境に合わせて変更してください）
cp /home/pi/stock-app-data/stock.db /media/pi/USB_DRIVE/backup/stock.db_$(date +%Y%m%d)
```

#### 復元
バックアップしたファイルを元の場所に戻します。**必ずアプリケーションを停止してから**行ってください。
```shell
# 1. アプリケーションを停止
docker stop stock-manager

# 2. バックアップファイルで上書き
cp /media/pi/USB_DRIVE/backup/stock.db_YYYYMMDD /home/pi/stock-app-data/stock.db

# 3. アプリケーションを起動
docker start stock-manager
```

---

## **Part 2: アプリケーション取扱説明書**
（実際にシステムを利用する方向け）

### 1. 概要と主な機能
このアプリケーションで何ができるかの全体像を説明します。

*   **管理者向け機能:**
    *   全工場の在庫状況と使用履歴の一元管理
    *   工場、部品、ユーザー、従業員などのマスターデータ登録
    *   発注が必要な部品のリストアップ
    *   棚卸しによる在庫数の調整
*   **整備工場ユーザー向け機能:**
    *   自工場の在庫数のリアルタイム確認
    *   部品の使用記録と履歴確認
    *   自工場に所属する従業員の登録・管理

### 2. 管理者ユーザー向けマニュアル

#### 2.1. ログイン
1.  ブラウザで `http://<ラズパイのIPアドレス>:3000` にアクセスします。
2.  初回ログイン時は、以下の情報を使用します。
    *   **ユーザー名:** `admin`
    *   **パスワード:** `password`
3.  ログイン後、セキュリティのため、ご自身の管理者アカウントを別途作成し、初期`admin`アカウントのパスワードを変更または削除することを推奨します。

#### 2.2. ダッシュボードの見方
ログインすると、画面上部に管理メニューがタブ形式で表示されます。各タブをクリックすることで、それぞれの管理機能に切り替わります。

#### 2.3. 各種管理機能（工場、部品、ユーザー、従業員など）
「工場管理」「部品マスタ管理」「ユーザー管理」「従業員管理」「カテゴリー管理」の各タブでは、それぞれ以下の操作が可能です。
*   **新規追加:** 画面上部のフォームに必要な情報を入力し、「追加」ボタンを押します。
*   **編集:** リストの右側にある「編集」ボタンを押すと、編集用のポップアップが表示されます。内容を修正して「保存」ボタンを押します。
*   **削除:** リストの右側にある「削除」ボタンを押します。確認メッセージが表示された後、削除が実行されます。

**補足:**
*   **ユーザー管理:** 「ロール」で「管理者」または「整備工場ユーザー」を選択できます。「整備工場ユーザー」の場合は、所属する工場を選択してください。
*   **部品マスタ管理:** CSVファイルを使った一括でのインポート・エクスポートも可能です。一括削除もできます。

#### 2.4. 在庫管理・棚卸し
*   **在庫管理タブ:**
    *   特定の工場の特定の部品在庫を手動で更新できます。
    *   CSVファイルを使って、全工場の在庫情報を一括でインポート（上書き更新）できます。
    *   画面下部の「全工場の在庫状況」では、工場や部品名で在庫を絞り込み検索できます。
*   **棚卸しタブ:**
    1.  棚卸し対象の工場を選択します。
    2.  現在のシステム在庫数が表示されるので、「実在庫数」の欄に実際の在庫数を入力します。
    3.  すべての入力が終わったら、「この内容で在庫を更新する」ボタンを押すと、システム在庫数が一括で更新されます。

#### 2.5. レポート
*   **発注管理タブ:**
    *   全部品のうち、「現在の在庫数」が「最低発注レベル」を下回っているものだけを一覧で表示します。
    *   CSVとしてダウンロードも可能です。
*   **レポートタブ:**
    *   開始日・終了日、工場、部品を指定して、部品の使用履歴を絞り込み検索できます。

### 3. 整備工場ユーザー向け操作マニュアル

#### 3.1. ログイン
1.  管理者によって作成された「整備工場ユーザー」のアカウントでログインします。
2.  ログインすると、自分が所属する工場の情報が表示されます。

#### 3.2. 部品の使用
1.  「**部品使用**」タブを開きます。
2.  「整備士」のドロップダウンから、作業を行った従業員を選択します。
3.  部品リストがカテゴリーごとに折りたたまれています。該当するカテゴリー名をクリックして開きます。
4.  使用した部品の右側にある「**使用**」ボタンをタップします。
5.  確認メッセージが表示されるので、「OK」を押すと在庫が1つ減り、使用が記録されます。

#### 3.3. 使用履歴の確認
1.  「**使用履歴**」タブを開きます。
2.  デフォルトで今月の使用履歴が表示されます。上部の「月を選択」で過去の履歴も確認できます。
3.  間違えて記録してしまった場合は、履歴の右側にある「**取り消し**」ボタンを押すことで、使用記録を取り消し、在庫数を元に戻すことができます。

#### 3.4. 従業員の管理
1.  「**従業員管理**」タブを開きます。
2.  新しい従業員を追加する場合は、上部のフォームに名前を入力して「追加」ボタンを押します。
3.  従業員の名前を変更したり、退職などでリストに表示させたくない場合（無効化）は、リストの右側にある「**編集**」ボタンから行います。

---

### **付録: CSVインポートフォーマット**

CSVファイルを使って部品マスタと在庫情報を一括で登録・更新できます。
お手持ちのExcelなどでデータを作成し、以下の形式に合わせて「CSV (カンマ区切り)(*.csv)」形式で保存してください。

**【重要】**
*   1行目は、必ず以下のヘッダー（列名）にしてください。
*   文字コードは**UTF-8**で保存してください。

#### **A. 部品マスタ用CSV**
部品の種類をまとめて登録する際に使用します。
*   **場所:** `[部品マスタ管理]`タブ → `CSVから部品を一括登録`

**ファイル名:** `parts_import.csv` (任意)
```csv
part_number,part_name,category_name
OF-001,オイルフィルター トヨタ/ダイハツ用,エンジン消耗品
BP-001,ブレーキパッド フロント 軽自動車用,ブレーキ関連
BT-001,バッテリー 40B19L,電装・点火系
```
*   `category_name`に存在しないカテゴリー名を指定した場合、そのカテゴリーが自動的に新規登録されます。
*   `category_name`を空にすると、「カテゴリーなし」として登録されます。

#### **B. 在庫情報用CSV**
各工場の在庫数をまとめて登録・更新する際に使用します。
*   **場所:** `[在庫管理]`タブ → `在庫情報のCSVインポート`
*   **注意:** このCSVをインポートする前に、使用する品番と工場名がシステムに登録されている必要があります。

**ファイル名:** `inventory_import.csv` (任意)
```csv
part_number,shop_name,quantity,min_reorder_level,location_info
OF-001,A整備工場,20,5,棚A-1
BP-001,A整備工場,10,3,棚B-2
OF-001,B整備工場,15,5,倉庫1
```
