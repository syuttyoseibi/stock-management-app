
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>委託在庫 使用記録</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        .part-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:active { background-color: #0056b3; }
        #status { margin-top: 20px; padding: 10px; background-color: #e0f7e0; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <h1>在庫使用記録 - [工場名]</h1>
    <input type="text" id="mechanic_name" placeholder="整備士名（オプション）" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px;">
    <div id="part-list"></div>
    <div id="status">部品を選択してください</div>

    <script>
        document.addEventListener('DOMContentLoaded', loadParts);
        const partListDiv = document.getElementById('part-list');
        const statusDiv = document.getElementById('status');
        const mechanicInput = document.getElementById('mechanic_name');

        async function loadParts() {
            const response = await fetch('/api/parts');
            const parts = await response.json();
            partListDiv.innerHTML = ''; 

            parts.forEach(part => {
                const item = document.createElement('div');
                item.className = 'part-item';
                
                const info = document.createElement('span');
                info.textContent = `${part.part_name} (在庫: ${part.current_stock})`;
                item.appendChild(info);

                const button = document.createElement('button');
                button.textContent = '使用';
                button.onclick = () => usePart(part.id, part.part_name);
                item.appendChild(button);
                
                partListDiv.appendChild(item);
            });
        }

        async function usePart(partId, partName) {
            const mechanic_name = mechanicInput.value;
            statusDiv.textContent = `${partName} を記録中...`;

            try {
                const response = await fetch('/api/use-part', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ part_id: partId, mechanic_name: mechanic_name })
                });
                const result = await response.json();
                
                if (response.ok) {
                    statusDiv.style.backgroundColor = '#e0f7e0';
                    statusDiv.textContent = `✅ ${partName} の使用を記録しました。残り在庫: ${result.stock_left}`;
                    loadParts(); 
                } else {
                    statusDiv.style.backgroundColor = '#f7e0e0';
                    statusDiv.textContent = `❌ エラー: ${result.error || '不明なエラー'}`;
                }
            } catch (error) {
                statusDiv.style.backgroundColor = '#f7e0e0';
                statusDiv.textContent = `通信エラー: サーバーに接続できません。`;
            }
        }
    </script>
</body>
</html>
