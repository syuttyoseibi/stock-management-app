<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>委託在庫管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .stock-badge {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
            font-size: 0.8em;
            margin-left: 8px;
        }
        .stock-safe { background-color: #198754; }
        .stock-warning { background-color: #ffc107; color: black; }
        .stock-danger { background-color: #dc3545; }
        .accordion-button:not(.collapsed)::after {
            background-image: var(--bs-accordion-btn-active-icon);
        }
        .accordion-button::after {
            background-image: var(--bs-accordion-btn-icon);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-box-seam"></i> 委託在庫管理</a>
            <div class="d-flex">
                <span class="navbar-text me-3">
                    ようこそ、<span id="username-display"></span>さん (<span id="shop-name-display"></span>)
                </span>
                <button class="btn btn-outline-light" onclick="logout()">ログアウト</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <ul class="nav nav-tabs" id="main-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="use-tab" data-bs-toggle="tab" data-bs-target="#use-view" type="button" role="tab">部品使用</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="usage-history-tab" data-bs-toggle="tab" data-bs-target="#usage-history-view" type="button" role="tab">使用履歴</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="replenishment-history-tab" data-bs-toggle="tab" data-bs-target="#replenishment-history-view" type="button" role="tab">補充履歴</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="employee-tab" data-bs-toggle="tab" data-bs-target="#employee-view" type="button" role="tab">従業員管理</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- 部品使用 -->
            <div class="tab-pane fade show active" id="use-view" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="employee_select" class="form-label">整備士</label>
                            <select id="employee_select" class="form-select">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <hr>
                        <h5 class="card-title">使用した部品を選択してください</h5>
                        <div class="accordion" id="part-list-accordion"></div>
                    </div>
                </div>
            </div>

            <!-- 使用履歴 -->
            <div class="tab-pane fade" id="usage-history-view" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">使用履歴</h5>
                        <div class="row g-3 align-items-end bg-light p-3 rounded">
                            <div class="col-md-4">
                                <label for="usage-start-date" class="form-label">開始日:</label>
                                <input type="date" id="usage-start-date" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="usage-end-date" class="form-label">終了日:</label>
                                <input type="date" id="usage-end-date" class="form-control">
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-primary" onclick="loadUsageHistory()"><i class="bi bi-search"></i> 表示</button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-success" onclick="exportUsageHistoryCSV()"><i class="bi bi-file-earmark-spreadsheet"></i> CSVエクスポート</button>
                            </div>
                        </div>
                        <div class="table-responsive mt-3">
                            <table id="usage-history-table" class="table table-striped table-hover">
                                <thead><tr><th>使用日時</th><th>品番</th><th>部品名</th><th>整備士</th><th>状態</th><th>操作</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 補充履歴 -->
            <div class="tab-pane fade" id="replenishment-history-view" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">補充履歴</h5>
                        <div class="row g-3 align-items-end bg-light p-3 rounded">
                            <div class="col-md-4">
                                <label for="replenishment-start-date" class="form-label">開始日:</label>
                                <input type="date" id="replenishment-start-date" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label for="replenishment-end-date" class="form-label">終了日:</label>
                                <input type="date" id="replenishment-end-date" class="form-control">
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-primary" onclick="loadReplenishmentHistory()"><i class="bi bi-search"></i> 表示</button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-success" onclick="exportReplenishmentHistoryCSV()"><i class="bi bi-file-earmark-spreadsheet"></i> CSVエクスポート</button>
                            </div>
                        </div>
                        <div class="table-responsive mt-3">
                            <table id="replenishment-history-table" class="table table-striped table-hover">
                                <thead><tr><th>補充日時</th><th>品番</th><th>部品名</th><th>補充数</th><th>担当者</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 従業員管理 -->
            <div class="tab-pane fade" id="employee-view" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">新しい従業員を追加</h5>
                        <div class="input-group mb-3">
                            <input type="text" id="new-employee-name" class="form-control" placeholder="従業員名">
                            <button class="btn btn-primary" onclick="addEmployee()">追加</button>
                        </div>
                        <p id="add-employee-message"></p>
                        <hr>
                        <h5 class="card-title">登録済み従業員リスト</h5>
                        <div class="table-responsive">
                            <table id="employees-table" class="table table-striped table-hover">
                                <thead><tr><th>従業員名</th><th>状態</th><th>操作</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="status" class="mt-3"></div>
    </div>

    <!-- Cancellation Modal -->
    <div class="modal fade" id="cancel-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">使用履歴の取り消し</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p>取り消し理由を入力してください（任意）</p>
                <input type="text" id="cancel-reason" class="form-control">
                <input type="hidden" id="usage-id-to-cancel">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-danger" onclick="submitCancellation()">取り消しを実行</button>
            </div>
        </div></div>
    </div>

    <!-- Employee Edit Modal -->
    <div class="modal fade" id="edit-employee-modal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">従業員情報の編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-employee-id">
                <div class="mb-3"><label for="edit-employee-name" class="form-label">従業員名:</label><input type="text" id="edit-employee-name" class="form-control"></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="edit-employee-is-active"><label class="form-check-label" for="edit-employee-is-active">有効な従業員</label></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="updateEmployee()">保存</button>
            </div>
        </div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const modals = {};
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            modals['cancel-modal'] = new bootstrap.Modal(document.getElementById('cancel-modal'));
            modals['edit-employee-modal'] = new bootstrap.Modal(document.getElementById('edit-employee-modal'));
            onPageLoad();
        });

        async function onPageLoad() {
            if (await checkAuth()) {
                await setupInitialView();
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                if (data.loggedIn && data.user.type === 'shop' && data.user.shop_id) {
                    currentUser = data.user;
                    return true;
                }
                showError('整備工場ユーザーとしてログインしていません。ログインページに戻ります。');
                setTimeout(() => { window.location.href = '/login.html'; }, 2000);
                return false;
            } catch (error) {
                showError('認証状態の確認中にエラーが発生しました。ログインページに戻ります。');
                setTimeout(() => { window.location.href = '/login.html'; }, 2000);
                return false;
            }
        }

        function setDefaultDateRange(startId, endId) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            document.getElementById(endId).value = endDate.toISOString().split('T')[0];
            document.getElementById(startId).value = startDate.toISOString().split('T')[0];
        }

        async function setupInitialView() {
            document.getElementById('username-display').textContent = currentUser.username;
            try {
                const shopResponse = await fetch('/api/shops');
                const shopData = await shopResponse.json();
                if (shopData && shopData.length > 0) {
                    document.getElementById('shop-name-display').textContent = shopData[0].name;
                }
            } catch (e) { console.error('Failed to load shop name', e); }

            await Promise.all([
                loadInventory(currentUser.shop_id),
                loadEmployees()
            ]);
            
            setDefaultDateRange('usage-start-date', 'usage-end-date');
            setDefaultDateRange('replenishment-start-date', 'replenishment-end-date');

            loadUsageHistory();
            loadReplenishmentHistory();

            // Add event listeners for tab clicks to reload data
            document.getElementById('usage-history-tab').addEventListener('shown.bs.tab', loadUsageHistory);
            document.getElementById('replenishment-history-tab').addEventListener('shown.bs.tab', loadReplenishmentHistory);
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login.html';
        }

        async function loadInventory(shopId) {
            const accordion = document.getElementById('part-list-accordion');
            accordion.innerHTML = '読み込み中...';
            try {
                const response = await fetch(`/api/shops/${shopId}/inventory`);
                if (!response.ok) throw new Error('在庫の取得に失敗しました');
                const inventory = await response.json();
                accordion.innerHTML = '';
                if (inventory.length === 0) {
                    accordion.innerHTML = '<p>この工場には在庫がありません。</p>';
                    return;
                }

                const partsByCategory = inventory.reduce((acc, part) => {
                    const category = part.category_name || 'カテゴリーなし';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(part);
                    return acc;
                }, {});

                let index = 0;
                for (const category in partsByCategory) {
                    const categoryId = `category-${index}`;
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';
                    accordionItem.innerHTML = `
                        <h2 class="accordion-header" id="heading-${categoryId}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${categoryId}">
                                ${category}
                            </button>
                        </h2>
                        <div id="collapse-${categoryId}" class="accordion-collapse collapse" data-bs-parent="#part-list-accordion">
                            <div class="list-group list-group-flush"></div>
                        </div>`;
                    
                    const listGroup = accordionItem.querySelector('.list-group');
                    const getStockStatusInfo = (q, min) => q <= 0 ? 'danger' : (q <= min ? 'danger' : (q <= min * 1.5 ? 'warning' : 'safe'));
                    const getStockText = (q, min) => q <= 0 ? '在庫なし' : `残 ${q}`;

                    partsByCategory[category].forEach(part => {
                        const status = getStockStatusInfo(part.quantity, part.min_reorder_level);
                        const text = getStockText(part.quantity, part.min_reorder_level);
                        const listItem = document.createElement('div');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            <div>
                                ${part.part_name} <small class="text-muted">(${part.part_number})</small>
                                <span class="stock-badge stock-${status}">${text}</span>
                            </div>
                            <button class="btn btn-sm btn-success use-button" onclick="usePart(${part.id}, '${part.part_name}')" ${part.quantity <= 0 ? 'disabled' : ''}>使用</button>
                        `;
                        listGroup.appendChild(listItem);
                    });
                    accordion.appendChild(accordionItem);
                    index++;
                }
            } catch (error) { showError(error.message); }
        }

        async function loadEmployees() {
            try {
                const response = await fetch('/api/employees');
                if (!response.ok) throw new Error('従業員リストの取得に失敗しました');
                const employees = await response.json();
                
                const employeeSelect = document.getElementById('employee_select');
                employeeSelect.innerHTML = '<option value="">選択してください</option>';
                employees.filter(e => e.is_active).forEach(emp => {
                    employeeSelect.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
                });

                const tableBody = document.querySelector('#employees-table tbody');
                tableBody.innerHTML = '';
                if (employees.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3">従業員が登録されていません。</td></tr>';
                    return;
                }
                employees.forEach(emp => {
                    tableBody.insertRow().innerHTML = `<td>${emp.name}</td><td><span class="badge bg-${emp.is_active ? 'success' : 'secondary'}">${emp.is_active ? '有効' : '無効'}</span></td><td><button class="btn btn-sm btn-secondary" onclick="openEditEmployeeModal(${emp.id}, '${emp.name}', ${emp.is_active})">編集</button></td>`;
                });
            } catch (error) { showMessage('add-employee-message', error.message, 'danger'); }
        }

        async function addEmployee() {
            const nameInput = document.getElementById('new-employee-name');
            const name = nameInput.value.trim();
            if (!name) return showMessage('add-employee-message', '従業員名を入力してください。', 'danger');
            try {
                const response = await fetch('/api/employees', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
                if (!response.ok) throw new Error((await response.json()).error);
                showMessage('add-employee-message', `従業員「${name}」を追加しました。`, 'success');
                nameInput.value = '';
                await loadEmployees();
            } catch (error) { showMessage('add-employee-message', `エラー: ${error.message}`, 'danger'); }
        }

        function openEditEmployeeModal(id, name, isActive) {
            document.getElementById('edit-employee-id').value = id;
            document.getElementById('edit-employee-name').value = name;
            document.getElementById('edit-employee-is-active').checked = isActive;
            modals['edit-employee-modal'].show();
        }

        async function updateEmployee() {
            const id = document.getElementById('edit-employee-id').value;
            const name = document.getElementById('edit-employee-name').value.trim();
            const is_active = document.getElementById('edit-employee-is-active').checked;
            if (!name) return alert('従業員名は必須です。');
            try {
                const response = await fetch(`/api/employees/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, is_active }) });
                if (!response.ok) throw new Error((await response.json()).error);
                modals['edit-employee-modal'].hide();
                await loadEmployees();
            } catch (error) { alert(`更新エラー: ${error.message}`); }
        }

        async function usePart(partId, partName) {
            const employee_id = document.getElementById('employee_select').value;
            if (!employee_id) return showError('整備士を選択してください。');
            if (!confirm(`${partName} を1つ使用します。よろしいですか？`)) return;

            showStatus(`「${partName}」を記録中...`);
            try {
                const response = await fetch('/api/use-part', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ part_id: partId, employee_id })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '不明なエラー');
                showSuccess(`✅ ${partName} の使用を記録しました。`);
                await loadInventory(currentUser.shop_id);
                loadUsageHistory(); // Refresh history
            } catch (error) { showError(`❌ エラー: ${error.message}`); }
        }

        async function loadUsageHistory() {
            const tableBody = document.querySelector('#usage-history-table tbody');
            const startDate = document.getElementById('usage-start-date').value;
            const endDate = document.getElementById('usage-end-date').value;
            if (!startDate || !endDate) {
                tableBody.innerHTML = '<tr><td colspan="6">開始日と終了日を選択してください。</td></tr>';
                return;
            }
            tableBody.innerHTML = '<tr><td colspan="6">読み込み中...</td></tr>';
            try {
                const response = await fetch(`/api/usage-history?startDate=${startDate}&endDate=${endDate}`);
                if (!response.ok) throw new Error('使用履歴の取得に失敗しました');
                const history = await response.json();
                tableBody.innerHTML = '';
                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">指定された期間の使用履歴はありません。</td></tr>';
                    return;
                }
                history.forEach(item => {
                    const row = tableBody.insertRow();
                    if (item.status === 'cancelled') row.classList.add('text-muted', 'text-decoration-line-through');
                    row.insertCell().textContent = new Date(item.usage_time).toLocaleString();
                    row.insertCell().textContent = item.part_number;
                    row.insertCell().textContent = item.part_name;
                    row.insertCell().textContent = item.employee_name;
                    row.insertCell().innerHTML = `<span class="badge bg-${item.status === 'active' ? 'info' : 'secondary'}">${item.status === 'active' ? '使用中' : '取消済'}</span>`;
                    const actionCell = row.insertCell();
                    if (item.status === 'active') {
                        actionCell.innerHTML = `<button class="btn btn-sm btn-danger" onclick="openCancelModal(${item.id})">取消</button>`;
                    }
                });
            } catch (error) { tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">${error.message}</td></tr>`; }
        }

        async function loadReplenishmentHistory() {
            const tableBody = document.querySelector('#replenishment-history-table tbody');
            const startDate = document.getElementById('replenishment-start-date').value;
            const endDate = document.getElementById('replenishment-end-date').value;
            if (!startDate || !endDate) {
                tableBody.innerHTML = '<tr><td colspan="5">開始日と終了日を選択してください。</td></tr>';
                return;
            }
            tableBody.innerHTML = '<tr><td colspan="5">読み込み中...</td></tr>';
            try {
                const response = await fetch(`/api/replenishment-history?startDate=${startDate}&endDate=${endDate}`);
                if (!response.ok) throw new Error('補充履歴の取得に失敗しました');
                const history = await response.json();
                tableBody.innerHTML = '';
                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5">指定された期間の補充履歴はありません。</td></tr>';
                    return;
                }
                history.forEach(item => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = new Date(item.replenished_at).toLocaleString();
                    row.insertCell().textContent = item.part_number;
                    row.insertCell().textContent = item.part_name;
                    row.insertCell().textContent = item.quantity_added;
                    row.insertCell().textContent = item.user_name;
                });
            } catch (error) { tableBody.innerHTML = `<tr><td colspan="5" class="text-danger">${error.message}</td></tr>`; }
        }

        function exportUsageHistoryCSV() {
            const startDate = document.getElementById('usage-start-date').value;
            const endDate = document.getElementById('usage-end-date').value;
            if (!startDate || !endDate) return alert('CSVをエクスポートするには開始日と終了日を選択してください。');
            window.location.href = `/api/usage-history/csv?startDate=${startDate}&endDate=${endDate}`;
        }

        function exportReplenishmentHistoryCSV() {
            const startDate = document.getElementById('replenishment-start-date').value;
            const endDate = document.getElementById('replenishment-end-date').value;
            if (!startDate || !endDate) return alert('CSVをエクスポートするには開始日と終了日を選択してください。');
            window.location.href = `/api/replenishment-history/csv?startDate=${startDate}&endDate=${endDate}`;
        }

        function openCancelModal(usageId) {
            document.getElementById('usage-id-to-cancel').value = usageId;
            document.getElementById('cancel-reason').value = '';
            modals['cancel-modal'].show();
        }

        async function submitCancellation() {
            const usageId = document.getElementById('usage-id-to-cancel').value;
            const reason = document.getElementById('cancel-reason').value;
            showStatus('取り消し処理を実行中...');
            try {
                const response = await fetch('/api/cancel-usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usage_id: usageId, reason: reason })
                });
                if (!response.ok) throw new Error((await response.json()).error || '取り消しに失敗しました。');
                showSuccess('使用履歴の取り消しが完了しました。');
                modals['cancel-modal'].hide();
                await Promise.all([
                    loadUsageHistory(),
                    loadInventory(currentUser.shop_id)
                ]);
            } catch (error) { showError(`エラー: ${error.message}`); }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const typeMap = { info: 'alert-secondary', success: 'alert-success', danger: 'alert-danger' };
            statusDiv.className = `alert ${typeMap[type] || 'alert-info'}`;
            statusDiv.textContent = message;
            statusDiv.scrollIntoView();
        }
        const showSuccess = (msg) => showStatus(msg, 'success');
        const showError = (msg) => showStatus(msg, 'danger');
        const showMessage = (id, msg, type) => showStatus(msg, type);

    </script>
</body>
</html>