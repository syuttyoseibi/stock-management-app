<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者ダッシュボード - 委託在庫管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .main-content {
            padding: 2rem;
            transition: margin-left .3s;
        }
        .logout-button {
            margin-top: auto;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .form-control-sm, .form-select-sm {
            font-size: 0.875rem;
        }
        .table-responsive {
            max-height: 60vh;
        }
        .stock-badge {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            display: inline-block;
            min-width: 50px;
            text-align: center;
        }
        .stock-safe { background-color: #198754; }
        .stock-warning { background-color: #ffc107; color: black; }
        .stock-danger { background-color: #dc3545; }

        .header {
            display: flex !important;
        }
        .details-section { display: none; }
        .clickable-badge { cursor: pointer; }
    </style>
</head>
<body>
    <!-- ヘッダー (常に表示) -->
    <header class="header d-flex justify-content-between align-items-center p-3 bg-dark text-white">
        <a href="#" class="d-flex align-items-center text-white text-decoration-none">
            <i class="bi bi-box-seam fs-4 me-2"></i>
            <span class="fs-4">ZAIKO</span>
        </a>
        <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
            <i class="bi bi-list fs-3"></i>
        </button>
    </header>

    <!-- サイドバー (常にオフキャンバス) -->
    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarMenuLabel">ZAIKO Menu</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#sidebarMenu" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-3">
            <ul class="nav nav-pills flex-column mb-auto">

                <li class="nav-item">
                    <a href="#inventory-management" id="inventory-management-nav-link" class="nav-link active" data-bs-toggle="tab" onclick="showTab('inventory-management')"><i class="bi bi-boxes"></i>在庫管理</a>
                </li>
                <li>
                    <a href="#master-data" id="master-data-nav-link" class="nav-link" data-bs-toggle="tab" onclick="showTab('master-data')"><i class="bi bi-database"></i>マスター管理</a>
                </li>
                <li>
                    <a href="#reports" class="nav-link" data-bs-toggle="tab" onclick="showTab('reports')"><i class="bi bi-file-earmark-bar-graph"></i>レポート</a>
                </li>
            </ul>
            <div class="logout-button mt-auto">
                 <small class="text-white">ようこそ, <span id="username-display"></span>さん</small>
                <button class="btn btn-danger w-100 mt-2" onclick="logout()"><i class="bi bi-box-arrow-right"></i> ログアウト</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div id="global-message"></div>
        <div class="tab-content">
            <!-- 在庫管理タブ -->
            <div class="tab-pane fade show active" id="inventory-management">
                <h1><i class="bi bi-boxes"></i> 在庫管理</h1>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#inv-list-tab">在庫一覧</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#inv-replenish-tab">補充</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#inv-stocktake-tab">棚卸し</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#inv-update-tab">在庫情報更新</a></li>
                        </ul>
                    </div>
                    <div class="card-body tab-content">
                        <!-- 在庫一覧 -->
                        <div class="tab-pane fade show active" id="inv-list-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>全工場の在庫状況</h4>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="inv-filter-shop" class="form-label">工場で絞り込み:</label>
                                    <select id="inv-filter-shop" class="form-select"><option value="">すべて</option></select>
                                </div>
                                <div class="col-md-6">
                                    <label for="inv-filter-part" class="form-label">部品名/品番で絞り込み:</label>
                                    <input type="text" id="inv-filter-part" class="form-control" placeholder="部品名または品番を入力...">
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table id="all-inventory-table" class="table table-striped table-hover">
                                    <thead><tr><th>工場名</th><th>品番</th><th>部品名</th><th>数量</th><th>最低発注レベル</th><th>保管場所</th><th>操作</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 補充 -->
                        <div class="tab-pane fade" id="inv-replenish-tab">
                            <h4>在庫補充</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3" id="replenish-employee-group" style="display: none;">
                                        <label for="replenish-employee-select" class="form-label">補充担当者:</label>
                                        <select id="replenish-employee-select" class="form-select"></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="replenish-shop-select" class="form-label">工場:</label>
                                        <select id="replenish-shop-select" class="form-select"></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="replenish-category-select" class="form-label">カテゴリーで絞り込み:</label>
                                        <select id="replenish-category-select" class="form-select">
                                            <option value="">すべてのカテゴリー</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="replenish-part-select" class="form-label">部品:</label>
                                        <select id="replenish-part-select" class="form-select"></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="replenish-quantity" class="form-label">補充数量:</label>
                                        <input type="number" id="replenish-quantity" class="form-control" min="1" value="1">
                                    </div>
                                    <button class="btn btn-primary" onclick="replenishStockFromForm()"><i class="bi bi-plus-circle"></i> 補充を実行</button>
                                    <p id="replenish-message" class="mt-3"></p>
                                </div>
                            </div>
                        </div>
                        <!-- 棚卸し -->
                        <div class="tab-pane fade" id="inv-stocktake-tab">
                            <h4>棚卸し</h4>
                            <div class="mb-3">
                                <label for="stocktake-shop-select" class="form-label">棚卸し対象の工場を選択してください:</label>
                                <select id="stocktake-shop-select" class="form-select"><option value="">-- 工場を選択 --</option></select>
                            </div>
                            <div id="stocktake-area" class="d-none">
                                <div class="table-responsive">
                                    <table id="stocktake-table" class="table table-sm">
                                        <thead><tr><th>品番</th><th>部品名</th><th>システム在庫</th><th>実在庫</th><th>差異</th><th>分析</th></tr></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <button id="update-stocktake-btn" class="btn btn-primary mt-3" onclick="updateStocktake()">この内容で在庫を更新する</button>
                                <p id="stocktake-message" class="mt-3"></p>
                            </div>
                        </div>
                        <!-- 在庫情報更新 -->
                        <div class="tab-pane fade" id="inv-update-tab">
                            <h4>在庫情報を更新</h4>
                             <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3"><label for="inventory-shop-select" class="form-label">工場:</label><select id="inventory-shop-select" class="form-select"></select></div>
                                    <div class="mb-3">
                                        <label for="inventory-category-select" class="form-label">カテゴリーで絞り込み:</label>
                                        <select id="inventory-category-select" class="form-select">
                                            <option value="">すべてのカテゴリー</option>
                                        </select>
                                    </div>
                                    <div class="mb-3"><label for="inventory-part-select" class="form-label">部品:</label><select id="inventory-part-select" class="form-select"></select></div>
                                    <div class="mb-3"><label for="inventory-quantity" class="form-label">数量:</label><input type="number" id="inventory-quantity" class="form-control" min="0" value="0"></div>
                                    <div class="mb-3"><label for="inventory-min-reorder-level" class="form-label">最低発注レベル:</label><input type="number" id="inventory-min-reorder-level" class="form-control" min="0" value="0"></div>
                                    <div class="mb-3"><label for="inventory-location-info" class="form-label">保管場所情報:</label><input type="text" id="inventory-location-info" class="form-control" placeholder="例: 棚A-3" list="location-list"><datalist id="location-list"></datalist></div>
                                    <button class="btn btn-primary" onclick="updateInventory()">在庫を更新</button>
                                    <p id="update-inventory-message" class="mt-3"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- マスター管理タブ -->
            <div class="tab-pane fade" id="master-data">
                <h1><i class="bi bi-database"></i> マスター管理</h1>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#master-parts-tab">部品</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#master-categories-tab">カテゴリー</a></li>
                            <li class="nav-item" id="master-suppliers-nav" style="display: none;"><a class="nav-link" data-bs-toggle="tab" href="#master-suppliers-tab">部品商</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#master-shops-tab">工場</a></li>
                            <li class="nav-item" id="master-supplier-employees-nav" style="display: none;"><a class="nav-link" data-bs-toggle="tab" href="#master-supplier-employees-tab">担当者</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#master-uncategorized-tab">未分類部品</a></li>
                        </ul>
                    </div>
                    <div class="card-body tab-content">
                        <!-- 部品 -->
                        <div class="tab-pane fade show active" id="master-parts-tab">
                             <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>部品マスタ</h4>
                                <div>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-part-modal"><i class="bi bi-plus-circle"></i> 新規追加</button>
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#import-parts-csv-modal"><i class="bi bi-file-earmark-arrow-up"></i> CSVインポート</button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <button class="btn btn-danger btn-sm" onclick="deleteSelectedParts()"><i class="bi bi-trash"></i> 選択した部品を削除</button>
                                    <button class="btn btn-secondary btn-sm" onclick="window.location.href='/api/admin/parts/csv'"><i class="bi bi-file-earmark-arrow-down"></i> CSVエクスポート</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table id="parts-table" class="table table-striped table-hover">
                                    <thead><tr><th><input type="checkbox" onclick="toggleAllPartCheckboxes(this)"></th><th>ID</th><th>品番</th><th>部品名</th><th>カテゴリー</th><th>操作</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- カテゴリー -->
                        <div class="tab-pane fade" id="master-categories-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>カテゴリーマスタ</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-category-modal"><i class="bi bi-plus-circle"></i> 新規追加</button>
                            </div>
                            <div class="table-responsive">
                                <table id="categories-table" class="table table-striped table-hover">
                                    <thead><tr><th>ID</th><th>カテゴリー名</th><th>操作</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 部品商 (Admin only) -->
                        <div class="tab-pane fade" id="master-suppliers-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>部品商マスタ</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-supplier-modal"><i class="bi bi-plus-circle"></i> 新規追加</button>
                            </div>
                            <div class="table-responsive">
                                <table id="suppliers-table" class="table table-striped table-hover">
                                    <thead><tr><th>ID</th><th>部品商名</th><th>ログインID</th><th>操作</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 工場 -->
                        <div class="tab-pane fade" id="master-shops-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>工場マスタ</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-shop-modal"><i class="bi bi-plus-circle"></i> 新規追加</button>
                            </div>
                            <div class="table-responsive">
                                <table id="shops-table" class="table table-striped table-hover">
                                    <thead><tr><th>ID</th><th>工場名</th><th>ログインID</th><th>操作</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 担当者 (Supplier only) -->
                        <div class="tab-pane fade" id="master-supplier-employees-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>担当者マスタ</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-supplier-employee-modal"><i class="bi bi-plus-circle"></i> 新規追加</button>
                            </div>
                            <div class="table-responsive">
                                <table id="supplier-employees-table" class="table table-striped table-hover">
                                    <thead><tr><th>ID</th><th>担当者名</th><th>状態</th><th>操作</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 未分類部品 -->
                        <div class="tab-pane fade" id="master-uncategorized-tab">
                            <h4>未分類部品のカテゴリー設定</h4>
                            <p>CSVからインポートされた、まだカテゴリーが設定されていない部品の一覧です。</p>
                            <p id="uncategorized-parts-message"></p>
                            <div class="table-responsive">
                                <table id="uncategorized-parts-table" class="table table-striped table-hover">
                                    <thead><tr><th>品番</th><th>部品名</th><th>割り当てるカテゴリー</th><th>操作</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- レポートタブ -->
            <div class="tab-pane fade" id="reports">
                <h1><i class="bi bi-file-earmark-bar-graph"></i> レポート</h1>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#report-reorder-tab">発注リスト</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#report-usage-tab">使用履歴</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#report-replenishment-history-tab">補充履歴</a></li>
                        </ul>
                    </div>
                    <div class="card-body tab-content">
                        <!-- 発注リスト -->
                        <div class="tab-pane fade show active" id="report-reorder-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>発注が必要な部品リスト</h4>
                                <button class="btn btn-secondary" onclick="window.location.href='/api/admin/reorder-list/csv'"><i class="bi bi-file-earmark-arrow-down"></i> CSVエクスポート</button>
                            </div>
                            <div class="table-responsive">
                                <table id="reorder-list-table" class="table table-striped table-hover">
                                    <thead><tr><th>工場名</th><th>品番</th><th>部品名</th><th>現在庫数</th><th>最低発注レベル</th><th>不足数</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 使用履歴 -->
                        <div class="tab-pane fade" id="report-usage-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>使用履歴レポート</h4>
                                <button class="btn btn-secondary" onclick="exportUsageHistoryCSV()"><i class="bi bi-file-earmark-arrow-down"></i> CSVエクスポート</button>
                            </div>
                            <div class="row g-3 align-items-end mb-3">
                                <div class="col-md-3"><label for="filter-start-date" class="form-label">開始日:</label><input type="date" id="filter-start-date" class="form-control"></div>
                                <div class="col-md-3"><label for="filter-end-date" class="form-label">終了日:</label><input type="date" id="filter-end-date" class="form-control"></div>
                                <div class="col-md-2"><label for="filter-shop-id" class="form-label">工場:</label><select id="filter-shop-id" class="form-select"><option value="">すべて</option></select></div>
                                <div class="col-md-3"><label for="filter-part-id" class="form-label">部品:</label><select id="filter-part-id" class="form-select"><option value="">すべて</option></select></div>
                                <div class="col-auto"><button class="btn btn-primary" onclick="loadUsageHistory()">絞り込み</button></div>
                                <div class="col-auto"><button class="btn btn-secondary" onclick="clearReportFilters()">クリア</button></div>
                            </div>
                            <div class="table-responsive">
                                <table id="usage-history-table" class="table table-striped table-hover">
                                    <thead><tr><th>工場名</th><th>品番</th><th>部品名</th><th>使用日時</th><th>従業員名</th><th>取消理由</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 補充履歴 -->
                        <div class="tab-pane fade" id="report-replenishment-history-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>補充履歴レポート</h4>
                                <button class="btn btn-secondary" onclick="exportReplenishmentHistoryCSV()"><i class="bi bi-file-earmark-arrow-down"></i> CSVエクスポート</button>
                            </div>
                            <div class="row g-3 align-items-end mb-3">
                                <div class="col-md-3"><label for="rh-filter-start-date" class="form-label">開始日:</label><input type="date" id="rh-filter-start-date" class="form-control"></div>
                                <div class="col-md-3"><label for="rh-filter-end-date" class="form-label">終了日:</label><input type="date" id="rh-filter-end-date" class="form-control"></div>
                                <div class="col-md-2"><label for="rh-filter-shop-id" class="form-label">工場:</label><select id="rh-filter-shop-id" class="form-select"><option value="">すべて</option></select></div>
                                <div class="col-md-3"><label for="rh-filter-part-id" class="form-label">部品:</label><select id="rh-filter-part-id" class="form-select"><option value="">すべて</option></select></div>
                                <div class="col-auto"><button class="btn btn-primary" onclick="loadReplenishmentHistory()">絞り込み</button></div>
                                <div class="col-auto"><button class="btn btn-secondary" onclick="clearReplenishmentHistoryFilters()">クリア</button></div>
                            </div>
                            <div class="table-responsive">
                                <table id="replenishment-history-table" class="table table-striped table-hover">
                                    <thead><tr><th>補充日時</th><th>工場名</th><th>品番</th><th>部品名</th><th>補充数</th><th>担当者</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Supplier Modal -->
    <div class="modal fade" id="add-supplier-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">新しい部品商を追加</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="new-supplier-name" class="form-label">部品商名:</label><input type="text" id="new-supplier-name" class="form-control"></div>
                    <div class="mb-3"><label for="new-supplier-username" class="form-label">ログインID:</label><input type="text" id="new-supplier-username" class="form-control"></div>
                    <div class="mb-3"><label for="new-supplier-password" class="form-label">パスワード:</label><input type="password" id="new-supplier-password" class="form-control"></div>
                    <p id="add-supplier-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="addSupplier()">追加</button></div>
            </div>
        </div>
    </div>
    <!-- Edit Supplier Modal -->
    <div class="modal fade" id="edit-supplier-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">部品商 編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-supplier-id">
                    <div class="mb-3"><label for="edit-supplier-name" class="form-label">部品商名:</label><input type="text" id="edit-supplier-name" class="form-control"></div>
                    <div class="mb-3"><label for="edit-supplier-username" class="form-label">ログインID:</label><input type="text" id="edit-supplier-username" class="form-control"></div>
                    <div class="mb-3"><label for="edit-supplier-password" class="form-label">新しいパスワード (変更する場合のみ):</label><input type="password" id="edit-supplier-password" class="form-control"></div>
                    <p id="edit-supplier-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="updateSupplier()">保存</button></div>
            </div>
        </div>
    </div>

    <!-- Add Supplier Employee Modal -->
    <div class="modal fade" id="add-supplier-employee-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">新しい担当者を追加</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="new-supplier-employee-name" class="form-label">担当者名:</label><input type="text" id="new-supplier-employee-name" class="form-control"></div>
                    <p id="add-supplier-employee-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="addSupplierEmployee()">追加</button></div>
            </div>
        </div>
    </div>
    <!-- Edit Supplier Employee Modal -->
    <div class="modal fade" id="edit-supplier-employee-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">担当者 編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-supplier-employee-id">
                    <div class="mb-3"><label for="edit-supplier-employee-name" class="form-label">担当者名:</label><input type="text" id="edit-supplier-employee-name" class="form-control"></div>
                    <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="edit-supplier-employee-is-active"><label class="form-check-label" for="edit-supplier-employee-is-active">有効</label></div>
                    <p id="edit-supplier-employee-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="updateSupplierEmployee()">保存</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="analysis-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">在庫差異 分析レポート</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="analysis-modal-body">
                    <!-- Analysis content will be injected here -->
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="replenish-from-list-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">在庫補充</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="rfl-shop-id">
                    <input type="hidden" id="rfl-part-id">
                    <p><strong>工場:</strong> <span id="rfl-shop-name"></span></p>
                    <p><strong>部品:</strong> <span id="rfl-part-name"></span></p>
                    <div class="mb-3" id="rfl-employee-group" style="display: none;">
                        <label for="rfl-employee-select" class="form-label">補充担当者:</label>
                        <select id="rfl-employee-select" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label for="rfl-quantity" class="form-label">補充数量:</label>
                        <input type="number" id="rfl-quantity" class="form-control" min="1" value="1">
                    </div>
                    <p id="rfl-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="replenishStockFromList()">補充を実行</button></div>
            </div>
        </div>
    </div>

    <!-- Add Shop Modal -->
    <div class="modal fade" id="add-shop-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">新しい工場を追加</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="new-shop-name" class="form-label">工場名:</label><input type="text" id="new-shop-name" class="form-control"></div>
                    <div class="mb-3"><label for="new-shop-username" class="form-label">ログインID:</label><input type="text" id="new-shop-username" class="form-control"></div>
                    <div class="mb-3"><label for="new-shop-password" class="form-label">パスワード:</label><input type="password" id="new-shop-password" class="form-control"></div>
                    <p id="add-shop-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="addShop()">追加</button></div>
            </div>
        </div>
    </div>
    <!-- Edit Shop Modal -->
    <div class="modal fade" id="edit-shop-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">工場編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-shop-id">
                    <div class="mb-3"><label for="edit-shop-name" class="form-label">工場名:</label><input type="text" id="edit-shop-name" class="form-control"></div>
                    <div class="mb-3"><label for="edit-shop-username" class="form-label">ログインID:</label><input type="text" id="edit-shop-username" class="form-control"></div>
                    <div class="mb-3"><label for="edit-shop-password" class="form-label">新しいパスワード (変更する場合のみ):</label><input type="password" id="edit-shop-password" class="form-control"></div>
                    <p id="edit-shop-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="updateShop()">保存</button></div>
            </div>
        </div>
    </div>
    <!-- Add Part Modal -->
    <div class="modal fade" id="add-part-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">新しい部品を追加</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="new-part-number" class="form-label">品番:</label><input type="text" id="new-part-number" class="form-control" placeholder="例: OF-004"></div>
                    <div class="mb-3"><label for="new-part-name" class="form-label">部品名:</label><input type="text" id="new-part-name" class="form-control" placeholder="例: オイルフィルター Y30"></div>
                    <div class="mb-3"><label for="new-part-category" class="form-label">カテゴリー:</label><select id="new-part-category" class="form-select"></select></div>
                    <p id="add-part-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="addPart()">追加</button></div>
            </div>
        </div>
    </div>
    <!-- Edit Part Modal -->
    <div class="modal fade" id="edit-part-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">部品編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-part-id">
                    <div class="mb-3"><label for="edit-part-number" class="form-label">品番:</label><input type="text" id="edit-part-number" class="form-control"></div>
                    <div class="mb-3"><label for="edit-part-name" class="form-label">部品名:</label><input type="text" id="edit-part-name" class="form-control"></div>
                    <div class="mb-3"><label for="edit-part-category" class="form-label">カテゴリー:</label><select id="edit-part-category" class="form-select"></select></div>
                    <p id="edit-part-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="updatePart()">保存</button></div>
            </div>
        </div>
    </div>
    <!-- Import Parts CSV Modal -->
    <div class="modal fade" id="import-parts-csv-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">CSVから部品を一括登録</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="csv-file-input" class="form-label">CSVファイル:</label><input type="file" id="csv-file-input" class="form-control" accept=".csv"></div>
                    <small class="d-block mt-1 text-muted">※ファイルには「品番(part_number)」と「品名(part_name)」に該当する列を含めてください。</small>
                    <p id="import-parts-message" class="mt-3"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="importPartsCSV()">インポート実行</button></div>
            </div>
        </div>
    </div>
    <!-- Add Category Modal -->
    <div class="modal fade" id="add-category-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">新しいカテゴリーを追加</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label for="new-category-name" class="form-label">カテゴリー名:</label><input type="text" id="new-category-name" class="form-control" placeholder="例: エンジンオイル"></div>
                    <p id="add-category-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="addCategory()">追加</button></div>
            </div>
        </div>
    </div>
    <!-- Edit Category Modal -->
    <div class="modal fade" id="edit-category-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">カテゴリー編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-category-id">
                    <div class="mb-3"><label for="edit-category-name" class="form-label">カテゴリー名:</label><input type="text" id="edit-category-name" class="form-control"></div>
                    <p id="edit-category-message"></p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button><button type="button" class="btn btn-primary" onclick="updateCategory()">保存</button></div>
            </div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div class="modal fade" id="edit-inventory-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">在庫情報 修正</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-inv-shop-id">
                    <input type="hidden" id="edit-inv-part-id">
                    <p><strong>工場:</strong> <span id="edit-inv-shop-name"></span></p>
                    <p><strong>部品:</strong> <span id="edit-inv-part-name"></span></p>
                    <p class="mb-3"><strong>現在の数量:</strong> <span id="edit-inv-quantity-display"></span></p>
                    <div class="mb-3">
                        <label for="edit-inv-min-reorder-level" class="form-label">最低発注レベル:</label>
                        <input type="number" id="edit-inv-min-reorder-level" class="form-control" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="edit-inv-location-info" class="form-label">保管場所情報:</label>
                        <input type="text" id="edit-inv-location-info" class="form-control" list="location-list">
                    </div>
                    <p id="edit-inventory-message"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-primary" onclick="updateInventoryItem()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store all modal instances
        const modals = {};
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.modal').forEach(modalEl => {
                modals[modalEl.id] = new bootstrap.Modal(modalEl);
            });
        });

        let currentUser = null;
        let allShops = [];
        let allSuppliers = [];
        let allParts = [];
        let allCategories = [];
        let allInventoryData = [];
        let allSupplierEmployees = [];
        let inventoryLocations = [];

        // --- Core Functions ---
        document.addEventListener('DOMContentLoaded', checkAuthAndLoadAdmin);

        async function checkAuthAndLoadAdmin() {
            try {
                const response = await fetch('/api/auth/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.loggedIn && (data.user.type === 'admin' || data.user.type === 'supplier')) {
                    currentUser = data.user;
                    document.getElementById('username-display').textContent = currentUser.name; // Use name instead of username
                    
                    await loadInitialData();
                    setupUIVisibility();
                    attachEventListeners();
                    loadAllAdminData(); // Load remaining data
                } else {
                    alert('アクセス権限がありません。ログインページに戻ります。');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                alert(`認証状態の確認中にエラーが発生しました: ${error.message}`);
                window.location.href = '/login.html';
            }
        }
        
        async function loadInitialData() {
            // Load data essential for initial UI setup
            await Promise.all([loadShops(), loadCategories()]);
        }

        function setupUIVisibility() {
            const userType = currentUser.type;
            
            // Admin-only elements
            document.getElementById('master-suppliers-nav').style.display = userType === 'admin' ? 'block' : 'none';

            // Supplier-only elements
            const employeeNav = document.getElementById('master-supplier-employees-nav');
            const replenishEmployeeGroup = document.getElementById('replenish-employee-group');
            if (userType === 'supplier') {
                employeeNav.style.display = 'block';
                replenishEmployeeGroup.style.display = 'block';
                document.getElementById('master-data-nav-link').innerHTML = `<i class="bi bi-pencil-square"></i> データ管理`;
                
                if (allShops.length === 0) {
                    showTab('master-data');
                    setTimeout(() => {
                        const masterTab = document.querySelector('#master-data .nav-tabs .nav-link[href="#master-shops-tab"]');
                        if(masterTab) new bootstrap.Tab(masterTab).show();
                    }, 150);
                } else {
                     showTab('inventory-management');
                }
            } else {
                employeeNav.style.display = 'none';
                replenishEmployeeGroup.style.display = 'none';
                showTab('inventory-management');
            }
        }

        function attachEventListeners() {
            document.getElementById('replenish-category-select').addEventListener('change', filterPartsForReplenishment);
            document.getElementById('inventory-category-select').addEventListener('change', filterPartsForInventoryUpdate);
            document.getElementById('inv-filter-shop').addEventListener('change', filterAllInventory);
            document.getElementById('inv-filter-part').addEventListener('input', filterAllInventory);
            document.getElementById('stocktake-shop-select').addEventListener('change', loadStocktakeList);
        }

        async function loadAllAdminData() {
            const promises = [
                loadParts(),
                loadAllInventory(),
                loadReorderList(),
                loadUsageHistory(),
                loadReplenishmentHistory(),
                loadInventoryLocations(),
                loadUncategorizedParts()
            ];

            if (currentUser.type === 'admin') {
                promises.push(loadSuppliers());
            }
            if (currentUser.type === 'supplier') {
                promises.push(loadSupplierEmployees());
            }

            try {
                await Promise.all(promises);
            } catch (error) {
                console.error("Error loading all admin data:", error);
                showMessage('global-message', 'データの読み込み中にエラーが発生しました。', 'danger');
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        function showTab(tabId) {
            const tabTrigger = document.querySelector(`.nav-link[href="#${tabId}"]`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
            }
        }
        
        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.className = `alert alert-${type} mt-3`;
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        if (element.classList.contains(`alert-${type}`)) {
                             element.className = '';
                             element.innerHTML = '';
                        }
                    }, 5000);
                }
            }
        }

        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (response.status === 204) { 
                    return null;
                }
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                return data;
            } catch (error) {
                console.error(`API request to ${url} failed:`, error);
                throw error;
            }
        }

        // --- Supplier Management (Admin only) ---
        async function loadSuppliers() {
            if (currentUser.type !== 'admin') return;
            try {
                allSuppliers = await apiRequest('/api/admin/suppliers');
                const tableBody = document.querySelector('#suppliers-table tbody');
                tableBody.innerHTML = '';
                allSuppliers.forEach(s => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td>${s.id}</td><td>${s.name}</td><td>${s.username}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openEditSupplierModal(${s.id})">編集</button> 
                            <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${s.id}, '${s.name}')">削除</button>
                        </td>`;
                });
            } catch (error) {
                showMessage('add-supplier-message', `部品商の読み込みエラー: ${error.message}`, 'danger');
            }
        }

        async function addSupplier() {
            const name = document.getElementById('new-supplier-name').value;
            const username = document.getElementById('new-supplier-username').value;
            const password = document.getElementById('new-supplier-password').value;
            if (!name || !username || !password) {
                showMessage('add-supplier-message', '部品商名、ログインID、パスワードは必須です。', 'danger');
                return;
            }
            try {
                await apiRequest('/api/admin/suppliers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, username, password })
                });
                showMessage('add-supplier-message', `部品商「${name}」を追加しました。`, 'success');
                document.getElementById('new-supplier-name').value = '';
                document.getElementById('new-supplier-username').value = '';
                document.getElementById('new-supplier-password').value = '';
                modals['add-supplier-modal'].hide();
                loadSuppliers();
            } catch (error) {
                showMessage('add-supplier-message', `エラー: ${error.message}`, 'danger');
            }
        }

        function openEditSupplierModal(id) {
            const supplier = allSuppliers.find(s => s.id === id);
            if (!supplier) return;
            document.getElementById('edit-supplier-id').value = supplier.id;
            document.getElementById('edit-supplier-name').value = supplier.name;
            document.getElementById('edit-supplier-username').value = supplier.username;
            document.getElementById('edit-supplier-password').value = '';
            showMessage('edit-supplier-message', '', 'info');
            modals['edit-supplier-modal'].show();
        }

        async function updateSupplier() {
            const id = document.getElementById('edit-supplier-id').value;
            const name = document.getElementById('edit-supplier-name').value;
            const username = document.getElementById('edit-supplier-username').value;
            const password = document.getElementById('edit-supplier-password').value;
            const payload = { name, username };
            if (password) {
                payload.password = password;
            }
            try {
                await apiRequest(`/api/admin/suppliers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showMessage('edit-supplier-message', '部品商情報を更新しました。', 'success');
                setTimeout(() => {
                    modals['edit-supplier-modal'].hide();
                    loadSuppliers();
                }, 1000);
            } catch (error) {
                showMessage('edit-supplier-message', `エラー: ${error.message}`, 'danger');
            }
        }

        async function deleteSupplier(id, name) {
            if (confirm(`本当に部品商「${name}」を削除しますか？
この部品商に紐づくデータがある場合は削除できません。`)) {
                try {
                    const data = await apiRequest(`/api/admin/suppliers/${id}`, { method: 'DELETE' });
                    alert(data.message);
                    loadSuppliers();
                } catch (error) {
                    alert(`エラー: ${error.message}`);
                }
            }
        }

        // --- Supplier Employee Management (Supplier only) ---
        async function loadSupplierEmployees() {
            if (currentUser.type !== 'supplier') return;
            try {
                allSupplierEmployees = await apiRequest('/api/supplier/employees');
                const tableBody = document.querySelector('#supplier-employees-table tbody');
                tableBody.innerHTML = '';
                allSupplierEmployees.forEach(e => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td>${e.id}</td><td>${e.name}</td>
                        <td><span class="badge bg-${e.is_active ? 'success' : 'secondary'}">${e.is_active ? '有効' : '無効'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openEditSupplierEmployeeModal(${e.id})">編集</button>
                        </td>`;
                });
                // Populate replenish employee select
                const employeeSelect = document.getElementById('replenish-employee-select');
                employeeSelect.innerHTML = '<option value="">-- 担当者を選択 --</option>';
                allSupplierEmployees.filter(e => e.is_active).forEach(e => {
                    employeeSelect.innerHTML += `<option value="${e.id}">${e.name}</option>`;
                });

            } catch (error) {
                showMessage('add-supplier-employee-message', `担当者の読み込みエラー: ${error.message}`, 'danger');
            }
        }

        async function addSupplierEmployee() {
            const name = document.getElementById('new-supplier-employee-name').value;
            if (!name) {
                showMessage('add-supplier-employee-message', '担当者名は必須です。', 'danger');
                return;
            }
            try {
                await apiRequest('/api/supplier/employees', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                showMessage('add-supplier-employee-message', `担当者「${name}」を追加しました。`, 'success');
                document.getElementById('new-supplier-employee-name').value = '';
                modals['add-supplier-employee-modal'].hide();
                loadSupplierEmployees();
            } catch (error) {
                showMessage('add-supplier-employee-message', `エラー: ${error.message}`, 'danger');
            }
        }

        function openEditSupplierEmployeeModal(id) {
            const employee = allSupplierEmployees.find(e => e.id === id);
            if (!employee) return;
            document.getElementById('edit-supplier-employee-id').value = employee.id;
            document.getElementById('edit-supplier-employee-name').value = employee.name;
            document.getElementById('edit-supplier-employee-is-active').checked = employee.is_active;
            showMessage('edit-supplier-employee-message', '', 'info');
            modals['edit-supplier-employee-modal'].show();
        }

        async function updateSupplierEmployee() {
            const id = document.getElementById('edit-supplier-employee-id').value;
            const name = document.getElementById('edit-supplier-employee-name').value;
            const isActive = document.getElementById('edit-supplier-employee-is-active').checked;
            try {
                await apiRequest(`/api/supplier/employees/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, is_active: isActive })
                });
                showMessage('edit-supplier-employee-message', '担当者情報を更新しました。', 'success');
                setTimeout(() => {
                    modals['edit-supplier-employee-modal'].hide();
                    loadSupplierEmployees();
                }, 1000);
            } catch (error) {
                showMessage('edit-supplier-employee-message', `エラー: ${error.message}`, 'danger');
            }
        }

        // --- Shop Management (Admin and Supplier) ---
        async function loadShops() {
            try {
                allShops = await apiRequest('/api/admin/shops');
                const tableBody = document.querySelector('#shops-table tbody');
                tableBody.innerHTML = '';
                allShops.forEach(shop => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td>${shop.id}</td><td>${shop.name}</td><td>${shop.username}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openEditShopModal(${shop.id})">編集</button> 
                            <button class="btn btn-sm btn-danger" onclick="deleteShop(${shop.id}, '${shop.name}')">削除</button>
                        </td>`;
                });

                const shopSelects = document.querySelectorAll('select[id*="shop-select"], select[id*="filter-shop"]');
                shopSelects.forEach(sel => {
                    const currentValue = sel.value;
                    const firstOptionHTML = sel.querySelector('option:first-child')?.outerHTML || '<option value="">すべて</option>';
                    sel.innerHTML = firstOptionHTML;
                    allShops.forEach(shop => {
                        sel.innerHTML += `<option value="${shop.id}">${shop.name}</option>`;
                    });
                    if (Array.from(sel.options).some(opt => opt.value === currentValue)) {
                        sel.value = currentValue;
                    }
                });
            } catch (error) {
                showMessage('add-shop-message', `工場の読み込みエラー: ${error.message}`, 'danger');
            }
        }

        async function addShop() {
            const name = document.getElementById('new-shop-name').value;
            const username = document.getElementById('new-shop-username').value;
            const password = document.getElementById('new-shop-password').value;
            if (!name || !username || !password) {
                showMessage('add-shop-message', '工場名、ログインID、パスワードは必須です。', 'danger');
                return;
            }
            try {
                await apiRequest('/api/admin/shops', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, username, password })
                });
                showMessage('add-shop-message', `工場「${name}」を追加しました。`, 'success');
                document.getElementById('new-shop-name').value = '';
                document.getElementById('new-shop-username').value = '';
                document.getElementById('new-shop-password').value = '';
                modals['add-shop-modal'].hide();
                await loadShops(); 
                setupUIVisibility(); 
            } catch (error) {
                showMessage('add-shop-message', `エラー: ${error.message}`, 'danger');
            }
        }

        function openEditShopModal(id) {
            const shop = allShops.find(s => s.id === id);
            if (!shop) return;
            document.getElementById('edit-shop-id').value = shop.id;
            document.getElementById('edit-shop-name').value = shop.name;
            document.getElementById('edit-shop-username').value = shop.username;
            document.getElementById('edit-shop-password').value = '';
            showMessage('edit-shop-message', '', 'info');
            modals['edit-shop-modal'].show();
        }

        async function updateShop() {
            const id = document.getElementById('edit-shop-id').value;
            const name = document.getElementById('edit-shop-name').value;
            const username = document.getElementById('edit-shop-username').value;
            const password = document.getElementById('edit-shop-password').value;
            const payload = { name, username };
            if (password) payload.password = password;
            try {
                await apiRequest(`/api/admin/shops/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showMessage('edit-shop-message', '工場情報を更新しました。', 'success');
                setTimeout(() => {
                    modals['edit-shop-modal'].hide();
                    loadShops();
                }, 1000);
            } catch (error) {
                showMessage('edit-shop-message', `エラー: ${error.message}`, 'danger');
            }
        }

        async function deleteShop(id, name) {
            if (confirm(`本当に工場「${name}」を削除しますか？
この工場に紐づく在庫などがある場合は削除できません。`)) {
                try {
                    const data = await apiRequest(`/api/admin/shops/${id}`, { method: 'DELETE' });
                    alert(data.message);
                    await loadShops();
                    setupUIVisibility();
                } catch (error) {
                    alert(`エラー: ${error.message}`);
                }
            }
        }

        // --- Part Management ---
        async function loadParts() {
            try {
                allParts = await apiRequest('/api/admin/parts');
                const tableBody = document.querySelector('#parts-table tbody');
                tableBody.innerHTML = '';
                allParts.forEach(part => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td><input type="checkbox" class="form-check-input part-checkbox" value="${part.id}"></td>
                        <td>${part.id}</td>
                        <td>${part.part_number}</td>
                        <td>${part.part_name}</td>
                        <td>${part.category_name || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openEditPartModal(${part.id})">編集</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePart(${part.id}, '${part.part_name}')">削除</button>
                        </td>`;
                });
                updatePartSelects();
            } catch (error) {
                showMessage('add-part-message', `部品の読み込みエラー: ${error.message}`, 'danger');
            }
        }
        
        function updatePartSelects() {
            const partSelects = document.querySelectorAll('select[id*="part-select"], select[id*="filter-part"]');
            partSelects.forEach(sel => {
                if (sel.id.includes('replenish') || sel.id.includes('inventory')) return; 
                const currentValue = sel.value;
                const firstOptionHTML = sel.querySelector('option:first-child')?.outerHTML || '<option value="">すべて</option>';
                sel.innerHTML = firstOptionHTML;
                allParts.forEach(part => {
                    sel.innerHTML += `<option value="${part.id}">${part.part_name} (${part.part_number})</option>`;
                });
                if (Array.from(sel.options).some(opt => opt.value === currentValue)) {
                    sel.value = currentValue;
                }
            });
            filterPartsForReplenishment();
            filterPartsForInventoryUpdate();
        }

        function filterPartsForReplenishment() {
            const categoryId = document.getElementById('replenish-category-select').value;
            const partSelect = document.getElementById('replenish-part-select');
            const currentValue = partSelect.value;
            partSelect.innerHTML = '<option value="">-- 部品を選択 --</option>';
            const filteredParts = categoryId ? allParts.filter(p => p.category_id == categoryId) : allParts;
            filteredParts.forEach(part => {
                partSelect.innerHTML += `<option value="${part.id}">${part.part_name} (${part.part_number})</option>`;
            });
            if (Array.from(partSelect.options).some(opt => opt.value === currentValue)) {
               partSelect.value = currentValue;
            }
        }

        function filterPartsForInventoryUpdate() {
            const categoryId = document.getElementById('inventory-category-select').value;
            const partSelect = document.getElementById('inventory-part-select');
            const currentValue = partSelect.value;
            partSelect.innerHTML = '<option value="">-- 部品を選択 --</option>';
            const filteredParts = categoryId ? allParts.filter(p => p.category_id == categoryId) : allParts;
            filteredParts.forEach(part => {
                partSelect.innerHTML += `<option value="${part.id}">${part.part_name} (${part.part_number})</option>`;
            });
            if (Array.from(partSelect.options).some(opt => opt.value === currentValue)) {
               partSelect.value = currentValue;
            }
        }

        async function addPart() {
            const part_number = document.getElementById('new-part-number').value;
            const part_name = document.getElementById('new-part-name').value;
            const category_id = document.getElementById('new-part-category').value;
            if (!part_number || !part_name) {
                showMessage('add-part-message', '品番と部品名は必須です。', 'danger');
                return;
            }
            try {
                await apiRequest('/api/admin/parts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ part_number, part_name, category_id: category_id || null })
                });
                showMessage('add-part-message', `部品「${part_name}」を追加しました。`, 'success');
                document.getElementById('new-part-number').value = '';
                document.getElementById('new-part-name').value = '';
                document.getElementById('new-part-category').value = '';
                modals['add-part-modal'].hide();
                loadParts();
            } catch (error) {
                showMessage('add-part-message', `エラー: ${error.message}`, 'danger');
            }
        }

        function openEditPartModal(id) {
            const part = allParts.find(p => p.id === id);
            if (!part) return;
            document.getElementById('edit-part-id').value = part.id;
            document.getElementById('edit-part-number').value = part.part_number;
            document.getElementById('edit-part-name').value = part.part_name;
            document.getElementById('edit-part-category').value = part.category_id || '';
            showMessage('edit-part-message', '', 'info');
            modals['edit-part-modal'].show();
        }

        async function updatePart() {
            const id = document.getElementById('edit-part-id').value;
            const part_number = document.getElementById('edit-part-number').value;
            const part_name = document.getElementById('edit-part-name').value;
            const category_id = document.getElementById('edit-part-category').value;
            try {
                await apiRequest(`/api/admin/parts/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ part_number, part_name, category_id: category_id || null })
                });
                showMessage('edit-part-message', '部品情報を更新しました。', 'success');
                setTimeout(() => {
                    modals['edit-part-modal'].hide();
                    loadParts();
                    loadUncategorizedParts();
                }, 1000);
            } catch (error) {
                showMessage('edit-part-message', `エラー: ${error.message}`, 'danger');
            }
        }

        async function deletePart(id, name) {
            if (confirm(`本当に部品「${name}」を削除しますか？
この部品の在庫が残っている場合は削除できません。`)) {
                try {
                    const data = await apiRequest(`/api/admin/parts/${id}`, { method: 'DELETE' });
                    alert(data.message);
                    loadParts();
                } catch (error) {
                    alert(`エラー: ${error.message}`);
                }
            }
        }

        function toggleAllPartCheckboxes(source) {
            document.querySelectorAll('.part-checkbox').forEach(checkbox => checkbox.checked = source.checked);
        }

        async function deleteSelectedParts() {
            const partIds = Array.from(document.querySelectorAll('.part-checkbox:checked')).map(cb => parseInt(cb.value));
            if (partIds.length === 0) {
                alert('削除する部品を選択してください。');
                return;
            }
            if (confirm(`${partIds.length}件の部品を本当に削除しますか？
いずれかの工場で在庫が残っている部品は削除できません。`)) {
                try {
                    const data = await apiRequest('/api/admin/parts', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ partIds })
                    });
                    alert(data.message || data.error);
                    loadParts();
                } catch (error) {
                    alert(`通信エラー: ${error.message}`);
                }
            }
        }

        async function importPartsCSV() {
            const fileInput = document.getElementById('csv-file-input');
            const messageEl = document.getElementById('import-parts-message');
            const file = fileInput.files[0];
            if (!file) {
                showMessage('import-parts-message', 'CSVファイルを選択してください。', 'danger');
                return;
            }
            const formData = new FormData();
            formData.append('csvFile', file);
            showMessage('import-parts-message', 'インポート処理を実行中...', 'info');
            try {
                const result = await apiRequest('/api/admin/parts/csv', { method: 'POST', body: formData });
                showMessage('import-parts-message', `${result.message} ${result.summary || ''}`, 'success');
                fileInput.value = '';
                modals['import-parts-csv-modal'].hide();
                await Promise.all([loadParts(), loadCategories(), loadUncategorizedParts()]);
            } catch (error) {
                 showMessage('import-parts-message', `インポート失敗: ${error.message}`, 'danger');
            }
        }

        async function loadUncategorizedParts() {
            try {
                const parts = await apiRequest('/api/admin/parts/uncategorized');
                const tableBody = document.querySelector('#uncategorized-parts-table tbody');
                tableBody.innerHTML = '';
                if (parts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4">未分類の部品はありません。</td></tr>';
                    return;
                }
                parts.forEach(part => {
                    let categorySelectHTML = `<select id="uncategorized-category-select-${part.id}" class="form-select form-select-sm"><option value="">-- カテゴリーを選択 --</option>`;
                    allCategories.forEach(cat => {
                        if (cat.name !== '未分類') categorySelectHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                    categorySelectHTML += `</select>`;
                    tableBody.insertRow().innerHTML = `
                        <td>${part.part_number}</td>
                        <td>${part.part_name}</td>
                        <td style="min-width: 150px;">${categorySelectHTML}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="assignCategory(${part.id})">保存</button></td>`;
                });
            } catch (error) {
                showMessage('uncategorized-parts-message', `未分類部品の読み込みエラー: ${error.message}`, 'danger');
            }
        }

        async function assignCategory(partId) {
            const categoryId = document.getElementById(`uncategorized-category-select-${partId}`).value;
            if (!categoryId) {
                showMessage('uncategorized-parts-message', 'カテゴリーを選択してください。', 'danger');
                return;
            }
            try {
                await apiRequest(`/api/admin/parts/${partId}/category`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoryId })
                });
                showMessage('uncategorized-parts-message', 'カテゴリーを保存しました。', 'success');
                await Promise.all([loadUncategorizedParts(), loadParts()]);
            } catch (error) {
                showMessage('uncategorized-parts-message', `保存エラー: ${error.message}`, 'danger');
            }
        }

        // --- Category Management ---
        async function loadCategories() {
            try {
                allCategories = await apiRequest('/api/admin/categories');
                const tableBody = document.querySelector('#categories-table tbody');
                tableBody.innerHTML = '';
                allCategories.forEach(cat => {
                    tableBody.insertRow().innerHTML = `<td>${cat.id}</td><td>${cat.name}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="openEditCategoryModal(${cat.id})">編集</button> 
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id}, '${cat.name}')">削除</button>
                        </td>`;
                });
                
                const categorySelects = document.querySelectorAll('select[id*="category-select"], select[id*="new-part-category"], select[id*="edit-part-category"]');
                categorySelects.forEach(sel => {
                    const currentValue = sel.value;
                    const firstOptionHTML = sel.querySelector('option:first-child')?.outerHTML || '<option value="">すべてのカテゴリー</option>';
                    sel.innerHTML = firstOptionHTML;
                    allCategories.forEach(cat => {
                        sel.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                    if (Array.from(sel.options).some(opt => opt.value === currentValue)) {
                        sel.value = currentValue;
                    }
                });
            } catch (error) {
                showMessage('add-category-message', `カテゴリーの読み込みエラー: ${error.message}`, 'danger');
            }
        }

        async function addCategory() {
            const name = document.getElementById('new-category-name').value;
            if (!name) {
                showMessage('add-category-message', 'カテゴリー名を入力してください。', 'danger');
                return;
            }
            try {
                await apiRequest('/api/admin/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                showMessage('add-category-message', `カテゴリー「${name}」を追加しました。`, 'success');
                document.getElementById('new-category-name').value = '';
                modals['add-category-modal'].hide();
                await loadCategories();
                await loadUncategorizedParts();
            } catch (error) {
                showMessage('add-category-message', `エラー: ${error.message}`, 'danger');
            }
        }

        function openEditCategoryModal(id) {
            const category = allCategories.find(c => c.id === id);
            if (!category) return;
            document.getElementById('edit-category-id').value = category.id;
            document.getElementById('edit-category-name').value = category.name;
            showMessage('edit-category-message', '', 'info');
            modals['edit-category-modal'].show();
        }

        async function updateCategory() {
            const id = document.getElementById('edit-category-id').value;
            const name = document.getElementById('edit-category-name').value;
            try {
                await apiRequest(`/api/admin/categories/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                showMessage('edit-category-message', 'カテゴリー名を更新しました。', 'success');
                setTimeout(() => {
                    modals['edit-category-modal'].hide();
                    loadCategories();
                }, 1000);
            } catch (error) {
                showMessage('edit-category-message', `エラー: ${error.message}`, 'danger');
            }
        }

        async function deleteCategory(id, name) {
            if (confirm(`本当にカテゴリー「${name}」を削除しますか？
このカテゴリーに属する部品がある場合は削除できません。`)) {
                try {
                    const data = await apiRequest(`/api/admin/categories/${id}`, { method: 'DELETE' });
                    alert(data.message);
                    loadCategories();
                } catch (error) {
                    alert(`エラー: ${error.message}`);
                }
            }
        }
        
        // --- Inventory Management ---
        async function loadAllInventory() {
            try {
                allInventoryData = await apiRequest('/api/admin/all-inventory');
                filterAllInventory();
            } catch (error) {
                console.error(`全在庫の読み込みエラー: ${error.message}`);
                document.querySelector('#all-inventory-table tbody').innerHTML = `<tr><td colspan="7" class="text-danger">在庫データの読み込みに失敗しました。</td></tr>`;
            }
        }

        function filterAllInventory() {
            const shopId = document.getElementById('inv-filter-shop').value;
            const partFilter = document.getElementById('inv-filter-part').value.toLowerCase();
            
            const filteredData = allInventoryData.filter(item => {
                const shopMatch = !shopId || item.shop_id == shopId;
                const partMatch = !partFilter || item.part_name.toLowerCase().includes(partFilter) || item.part_number.toLowerCase().includes(partFilter);
                return shopMatch && partMatch;
            });

            renderAllInventoryTable(filteredData);
        }

        function renderAllInventoryTable(data) {
            const tableBody = document.querySelector('#all-inventory-table tbody');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">表示する在庫データがありません。</td></tr>';
                return;
            }
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.shop_name}</td>
                    <td>${item.part_number}</td>
                    <td>${item.part_name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.min_reorder_level}</td>
                    <td>${item.location_info || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="openReplenishFromListModal(${item.shop_id}, ${item.part_id})">補充</button>
                        <button class="btn btn-sm btn-secondary" onclick="openEditInventoryModal(${item.shop_id}, ${item.part_id})">修正</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInventoryItem(${item.shop_id}, ${item.part_id}, '${item.shop_name}', '${item.part_name}')">削除</button>
                    </td>`;
            });
        }
        
        function openReplenishFromListModal(shopId, partId) {
            const shop = allShops.find(s => s.id === shopId);
            const part = allParts.find(p => p.id === partId);
            if (!shop || !part) return;

            document.getElementById('rfl-shop-id').value = shopId;
            document.getElementById('rfl-part-id').value = partId;
            document.getElementById('rfl-shop-name').textContent = shop.name;
            document.getElementById('rfl-part-name').textContent = `${part.part_name} (${part.part_number})`;
            document.getElementById('rfl-quantity').value = 1;

            const employeeGroup = document.getElementById('rfl-employee-group');
            if (currentUser.type === 'supplier') {
                const employeeSelect = document.getElementById('rfl-employee-select');
                employeeSelect.innerHTML = '<option value="">-- 担当者を選択 --</option>';
                allSupplierEmployees.filter(e => e.is_active).forEach(e => {
                    employeeSelect.innerHTML += `<option value="${e.id}">${e.name}</option>`;
                });
                employeeGroup.style.display = 'block';
            } else {
                employeeGroup.style.display = 'none';
            }

            showMessage('rfl-message', '', 'info');
            modals['replenish-from-list-modal'].show();
        }

        async function replenishStockFromList() {
            const shopId = document.getElementById('rfl-shop-id').value;
            const partId = document.getElementById('rfl-part-id').value;
            const quantity = document.getElementById('rfl-quantity').value;
            const employeeId = document.getElementById('rfl-employee-select').value;
            
            await replenishStock(shopId, partId, quantity, employeeId, 'rfl-message', () => {
                modals['replenish-from-list-modal'].hide();
            });
        }
        
        async function replenishStockFromForm() {
            const shopId = document.getElementById('replenish-shop-select').value;
            const partId = document.getElementById('replenish-part-select').value;
            const quantity = document.getElementById('replenish-quantity').value;
            const employeeId = document.getElementById('replenish-employee-select').value;
            
            await replenishStock(shopId, partId, quantity, employeeId, 'replenish-message', () => {
                 // Clear form
                document.getElementById('replenish-part-select').value = '';
                document.getElementById('replenish-quantity').value = 1;
            });
        }

        async function replenishStock(shopId, partId, quantity, employeeId, messageElId, callback) {
             if (!shopId || !partId || !quantity) {
                showMessage(messageElId, '工場、部品、数量は必須です。', 'danger');
                return;
            }
            if (currentUser.type === 'supplier' && !employeeId) {
                showMessage(messageElId, '補充担当者を選択してください。', 'danger');
                return;
            }

            const body = {
                shop_id: shopId,
                part_id: partId,
                quantity_added: quantity, // Correct key name
                performed_by_supplier_employee_id: currentUser.type === 'supplier' ? employeeId : null // Correct key name
            };

            try {
                await apiRequest('/api/admin/inventory/replenish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                showMessage(messageElId, '在庫を補充しました。', 'success');
                await Promise.all([loadAllInventory(), loadReplenishmentHistory()]);
                if (callback) callback();
            } catch (error) {
                showMessage(messageElId, `補充エラー: ${error.message}`, 'danger');
            }
        }
        
        // --- Reports ---
        async function loadReorderList() {
            try {
                const data = await apiRequest('/api/admin/reorder-list');
                const tableBody = document.querySelector('#reorder-list-table tbody');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">発注が必要な部品はありません。</td></tr>';
                    return;
                }
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    const shortage = item.min_reorder_level - item.quantity;
                    row.innerHTML = `
                        <td>${item.shop_name}</td>
                        <td>${item.part_number}</td>
                        <td>${item.part_name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.min_reorder_level}</td>
                        <td>${shortage > 0 ? shortage : 0}</td>`;
                });
            } catch (error) {
                document.querySelector('#reorder-list-table tbody').innerHTML = `<tr><td colspan="6" class="text-danger">発注リストの読み込みに失敗しました。</td></tr>`;
            }
        }
        async function loadUsageHistory() {
            const params = new URLSearchParams({
                startDate: document.getElementById('filter-start-date').value,
                endDate: document.getElementById('filter-end-date').value,
                shopId: document.getElementById('filter-shop-id').value,
                partId: document.getElementById('filter-part-id').value,
            }).toString();
            try {
                const data = await apiRequest(`/api/admin/all-usage-history?${params}`);
                const tableBody = document.querySelector('#usage-history-table tbody');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">該当する使用履歴はありません。</td></tr>';
                    return;
                }
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.shop_name}</td>
                        <td>${item.part_number}</td>
                        <td>${item.part_name}</td>
                        <td>${new Date(item.used_at).toLocaleString()}</td>
                        <td>${item.employee_name || 'N/A'}</td>
                        <td>${item.cancellation_reason || ''}</td>`;
                });
            } catch (error) {
                 document.querySelector('#usage-history-table tbody').innerHTML = `<tr><td colspan="6" class="text-danger">使用履歴の読み込みに失敗しました。</td></tr>`;
            }
        }
        async function loadReplenishmentHistory() {
            const params = new URLSearchParams({
                startDate: document.getElementById('rh-filter-start-date').value,
                endDate: document.getElementById('rh-filter-end-date').value,
                shopId: document.getElementById('rh-filter-shop-id').value,
                partId: document.getElementById('rh-filter-part-id').value,
            }).toString();
            try {
                const data = await apiRequest(`/api/admin/replenishment-history?${params}`);
                const tableBody = document.querySelector('#replenishment-history-table tbody');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">該当する補充履歴はありません。</td></tr>';
                    return;
                }
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(item.replenished_at).toLocaleString()}</td>
                        <td>${item.shop_name}</td>
                        <td>${item.part_number}</td>
                        <td>${item.part_name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.supplier_employee_name || 'N/A'}</td>`;
                });
            } catch (error) {
                document.querySelector('#replenishment-history-table tbody').innerHTML = `<tr><td colspan="6" class="text-danger">補充履歴の読み込みに失敗しました。</td></tr>`;
            }
        }
        async function loadInventoryLocations() {
            try {
                inventoryLocations = await apiRequest('/api/admin/inventory/locations');
                const datalist = document.getElementById('location-list');
                datalist.innerHTML = '';
                inventoryLocations.forEach(loc => {
                    datalist.innerHTML += `<option value="${loc.location_info}">`;
                });
            } catch (error) {
                console.error('Failed to load inventory locations:', error);
            }
        }
        async function updateInventory() {
            const shop_id = document.getElementById('inventory-shop-select').value;
            const part_id = document.getElementById('inventory-part-select').value;
            const quantity = document.getElementById('inventory-quantity').value;
            const min_reorder_level = document.getElementById('inventory-min-reorder-level').value;
            const location_info = document.getElementById('inventory-location-info').value;

            if (!shop_id || !part_id) {
                showMessage('update-inventory-message', '工場と部品を選択してください。', 'danger');
                return;
            }
            try {
                await apiRequest('/api/admin/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop_id, part_id, quantity, min_reorder_level, location_info })
                });
                showMessage('update-inventory-message', '在庫情報を更新しました。', 'success');
                loadAllInventory();
            } catch (error) {
                showMessage('update-inventory-message', `更新エラー: ${error.message}`, 'danger');
            }
        }
        async function loadStocktakeList() {
            const shopId = document.getElementById('stocktake-shop-select').value;
            const stocktakeArea = document.getElementById('stocktake-area');
            const tableBody = document.querySelector('#stocktake-table tbody');
            
            if (!shopId) {
                stocktakeArea.classList.add('d-none');
                return;
            }
            
            try {
                const data = await apiRequest(`/api/shops/${shopId}/inventory`);
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">この工場の在庫情報はありません。</td></tr>';
                } else {
                    data.forEach(item => {
                        const row = tableBody.insertRow();
                        row.dataset.partId = item.part_id;
                        row.innerHTML = `
                            <td>${item.part_number}</td>
                            <td>${item.part_name}</td>
                            <td class="system-qty">${item.quantity}</td>
                            <td><input type="number" class="form-control form-control-sm actual-qty" value="${item.quantity}" min="0"></td>
                            <td class="discrepancy">0</td>
                            <td><button class="btn btn-sm btn-info" onclick="analyzeDiscrepancy(${item.part_id}, ${shopId})">分析</button></td>`;
                    });
                }
                stocktakeArea.classList.remove('d-none');
            } catch (error) {
                showMessage('stocktake-message', `棚卸しリストの読み込みエラー: ${error.message}`, 'danger');
                stocktakeArea.classList.add('d-none');
            }
        }
        
        document.querySelector('#stocktake-table').addEventListener('input', (e) => {
            if (e.target.classList.contains('actual-qty')) {
                const row = e.target.closest('tr');
                const systemQty = parseInt(row.querySelector('.system-qty').textContent);
                const actualQty = parseInt(e.target.value);
                const discrepancyCell = row.querySelector('.discrepancy');
                const discrepancy = actualQty - systemQty;
                discrepancyCell.textContent = discrepancy;
                discrepancyCell.style.color = discrepancy === 0 ? 'black' : 'red';
            }
        });

        async function updateStocktake() {
            const shopId = document.getElementById('stocktake-shop-select').value;
            const updates = [];
            document.querySelectorAll('#stocktake-table tbody tr').forEach(row => {
                if (row.dataset.partId) {
                    const partId = row.dataset.partId;
                    const actualQuantity = row.querySelector('.actual-qty').value;
                    updates.push({ part_id: partId, quantity: actualQuantity });
                }
            });

            if (updates.length === 0) {
                showMessage('stocktake-message', '更新するデータがありません。', 'info');
                return;
            }

            try {
                await apiRequest('/api/admin/inventory/stocktake', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop_id: shopId, updates })
                });
                showMessage('stocktake-message', '棚卸し結果を反映し、在庫を更新しました。', 'success');
                loadAllInventory();
                loadStocktakeList(); // Refresh the list
            } catch (error) {
                showMessage('stocktake-message', `更新エラー: ${error.message}`, 'danger');
            }
        }
        
        async function analyzeDiscrepancy(partId, shopId) {
            // This is a placeholder for a more detailed analysis feature.
            // For now, it can just show recent history for that part.
            const modalBody = document.getElementById('analysis-modal-body');
            modalBody.innerHTML = '<p>分析データを読み込み中...</p>';
            modals['analysis-modal'].show();
            
            try {
                const [usage, replenishment] = await Promise.all([
                    apiRequest(`/api/reports/usage?partId=${partId}&shopId=${shopId}`),
                    apiRequest(`/api/reports/replenishment?partId=${partId}&shopId=${shopId}`)
                ]);

                let html = '<h5>最近の使用履歴</h5>';
                if(usage.length > 0) {
                    html += '<ul class="list-group mb-3">';
                    usage.slice(0, 5).forEach(u => {
                        html += `<li class="list-group-item">${new Date(u.used_at).toLocaleString()}: ${u.employee_name || '不明'}が使用 ${u.cancellation_reason ? `(取消: ${u.cancellation_reason})` : ''}</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p>最近の使用履歴はありません。</p>';
                }

                html += '<h5>最近の補充履歴</h5>';
                if(replenishment.length > 0) {
                    html += '<ul class="list-group">';
                    replenishment.slice(0, 5).forEach(r => {
                        html += `<li class="list-group-item">${new Date(r.replenished_at).toLocaleString()}: ${r.quantity}個補充 (${r.supplier_employee_name || '不明'})</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p>最近の補充履歴はありません。</p>';
                }
                modalBody.innerHTML = html;

            } catch (error) {
                modalBody.innerHTML = `<p class="text-danger">分析データの読み込みに失敗しました: ${error.message}</p>`;
            }
        }

        function exportUsageHistoryCSV() {
            const params = new URLSearchParams({
                startDate: document.getElementById('filter-start-date').value,
                endDate: document.getElementById('filter-end-date').value,
                shopId: document.getElementById('filter-shop-id').value,
                partId: document.getElementById('filter-part-id').value,
            }).toString();
            window.location.href = `/api/reports/usage/csv?${params}`;
        }
        function clearReportFilters() {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-shop-id').value = '';
            document.getElementById('filter-part-id').value = '';
            loadUsageHistory();
        }
        function exportReplenishmentHistoryCSV() {
             const params = new URLSearchParams({
                startDate: document.getElementById('rh-filter-start-date').value,
                endDate: document.getElementById('rh-filter-end-date').value,
                shopId: document.getElementById('rh-filter-shop-id').value,
                partId: document.getElementById('rh-filter-part-id').value,
            }).toString();
            window.location.href = `/api/reports/replenishment/csv?${params}`;
        }
        function clearReplenishmentHistoryFilters() {
            document.getElementById('rh-filter-start-date').value = '';
            document.getElementById('rh-filter-end-date').value = '';
            document.getElementById('rh-filter-shop-id').value = '';
            document.getElementById('rh-filter-part-id').value = '';
            loadReplenishmentHistory();
        }

        async function deleteInventoryItem(shopId, partId, shopName, partName) {
            if (!confirm(`【確認】\n\n工場「${shopName}」の在庫から\n部品「${partName}」\n\nを削除します。よろしいですか？\nこの操作は元に戻せません。`)) {
                return;
            }

            try {
                await apiRequest('/api/admin/inventory', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop_id: shopId, part_id: partId })
                });
                showMessage('global-message', `「${shopName}」から「${partName}」を削除しました。`, 'success');
                loadAllInventory(); // Refresh the inventory list
            } catch (error) {
                showMessage('global-message', `在庫の削除中にエラーが発生しました: ${error.message}`, 'danger');
            }
        }

        function openEditInventoryModal(shopId, partId) {
            const item = allInventoryData.find(i => i.shop_id === shopId && i.part_id === partId);
            if (!item) {
                alert('対象の在庫データが見つかりません。');
                return;
            }

            const modalElement = document.getElementById('edit-inventory-modal');
            modalElement.dataset.originalQuantity = item.quantity; // Store original quantity

            document.getElementById('edit-inv-shop-id').value = item.shop_id;
            document.getElementById('edit-inv-part-id').value = item.part_id;
            document.getElementById('edit-inv-shop-name').textContent = item.shop_name;
            document.getElementById('edit-inv-part-name').textContent = `${item.part_name} (${item.part_number})`;
            document.getElementById('edit-inv-quantity-display').textContent = item.quantity; // Display only
            document.getElementById('edit-inv-min-reorder-level').value = item.min_reorder_level;
            document.getElementById('edit-inv-location-info').value = item.location_info || '';
            
            showMessage('edit-inventory-message', ''); // Clear previous messages
            modals['edit-inventory-modal'].show();
        }

        async function updateInventoryItem() {
            const modalElement = document.getElementById('edit-inventory-modal');
            const shop_id = document.getElementById('edit-inv-shop-id').value;
            const part_id = document.getElementById('edit-inv-part-id').value;
            const quantity = modalElement.dataset.originalQuantity; // Use original quantity
            const min_reorder_level = document.getElementById('edit-inv-min-reorder-level').value;
            const location_info = document.getElementById('edit-inv-location-info').value;

            try {
                await apiRequest('/api/admin/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shop_id, part_id, quantity, min_reorder_level, location_info })
                });
                showMessage('edit-inventory-message', '在庫情報を更新しました。', 'success');
                
                setTimeout(() => {
                    modals['edit-inventory-modal'].hide();
                    loadAllInventory();
                }, 1000);

            } catch (error) {
                showMessage('edit-inventory-message', `更新エラー: ${error.message}`, 'danger');
            }
        }
    </script>
</body>
</html>
